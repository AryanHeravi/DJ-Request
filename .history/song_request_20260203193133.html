<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Granville Warehouse Song Requests</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #0d0d0d;
    color: white;
    text-align: center;
    padding: 20px;
  }

  input {
    width: 90%;
    max-width: 400px;
    padding: 12px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 6px;
    border: none;
  }

  .button-img {
    width: 220px;
    margin: 10px;
    cursor: pointer;
    transition: transform 0.15s ease;
  }

  .button-img:hover {
    transform: scale(1.05);
  }

  .lane {
    margin-top: 30px;
  }

  .song {
    padding: 10px;
    border-bottom: 1px solid #333;
    font-size: 14px;
  }

  .hidden {
    display: none;
  }

  .notice {
    margin-top: 40px;
    font-size: 16px;
    opacity: 0.85;
  }
</style>
</head>

<body>

<h2>ðŸŽ¶ Granville Warehouse Song Requests</h2>

<div id="app">

  <input id="songInput" placeholder="Artist â€“ Song Name" />

  <div>
    <img src="Group 1 (6).png" class="button-img" onclick="sendRequest('free')" />
    <img src="Group 2 (5).png" class="button-img" onclick="sendRequest('fast')" />
  </div>

  <div class="lane">
    <h3>âš¡ Fast Pass</h3>
    <div id="fastLane"></div>
  </div>

  <div class="lane">
    <h3>ðŸŽ§ Free Requests</h3>
    <div id="freeLane"></div>
  </div>

</div>

<div id="closedMessage" class="hidden notice">
  This Granville Warehouse song request web app is only available during my working hours.
  <br><br>
  ðŸ•— 8:00 PM â€“ 2:00 AM (Thursday â€“ Monday)
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRzE9DheGAxan7h2NLB14Va3hI4Pc5EKM",
  authDomain: "aryauxsongrequest.firebaseapp.com",
  databaseURL: "https://aryauxsongrequest-default-rtdb.firebaseio.com",
  projectId: "aryauxsongrequest",
  storageBucket: "aryauxsongrequest.firebasestorage.app",
  messagingSenderId: "376455919089",
  appId: "1:376455919089:web:4962df21f4145b61c30050",
  measurementId: "G-F8MTQQE489"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const fastRef = ref(db, "fast_requests");
const freeRef = ref(db, "free_requests");

function getVancouverNow() {
  return new Date(new Date().toLocaleString("en-US", { timeZone: "America/Vancouver" }));
}

function isWithinWorkingHours() {
  const now = getVancouverNow();
  const day = now.getDay();
  const hour = now.getHours();

  const validDays = [0,1,4,5,6]; // Sun, Mon, Thu, Fri, Sat
  if (!validDays.includes(day)) return false;

  if (hour >= 20) return true;
  if (hour < 2) return true;

  return false;
}

function checkVisibility() {
  const app = document.getElementById("app");
  const closed = document.getElementById("closedMessage");

  if (isWithinWorkingHours()) {
    app.classList.remove("hidden");
    closed.classList.add("hidden");
  } else {
    app.classList.add("hidden");
    closed.classList.remove("hidden");
  }
}

function clearAt2AM() {
  const now = getVancouverNow();
  if (now.getHours() === 2 && now.getMinutes() === 0) {
    remove(fastRef);
    remove(freeRef);
  }
}

window.sendRequest = function(type) {
  if (!isWithinWorkingHours()) return;

  const input = document.getElementById("songInput");
  if (!input.value.trim()) return;

  const now = getVancouverNow();
  const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const data = {
    song: input.value,
    time: time
  };

  push(type === "fast" ? fastRef : freeRef, data);
  input.value = "";
};

function renderLane(refNode, containerId) {
  onValue(refNode, snapshot => {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    snapshot.forEach(child => {
      const div = document.createElement("div");
      div.className = "song";
      div.textContent = `${child.val().time} â€” ${child.val().song}`;
      container.appendChild(div);
    });
  });
}

renderLane(fastRef, "fastLane");
renderLane(freeRef, "freeLane");

checkVisibility();
setInterval(checkVisibility, 60000);
setInterval(clearAt2AM, 60000);
</script>

</body>
</html>
